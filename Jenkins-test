node {
    git credentialsId: 'sabbir_newroz_key', url: 'git@github.com:by-sabbir/django-docker-jenkins.git'
    
    try {
        stage 'Run unit/integration tests'
        sh 'make test'
        
        stage 'Building Project'
        sh 'make build'
        
        stage 'Project Release'
        sh 'make release'
        
        stage 'Tag and Publish release image'
        sh 'make tag latest \$(git rev-parse --short HEAD) \$(git tag --points-at HEAD)'
        sh 'make buildtag master \$(git tag --points-at HEAD)'
        
        withEnv(["DOCKER_USER=${DOCKER_USER}",
                 "DOCKER_PASSWORD=${DOCKER_PASSWORD}"]) {
            sh "make login"
        }
        
        sh "make publish"
    }
    
    finally {
        stage 'collect test reports'
        step(junit '**/reports/*.xml')
        
        stage "cleanup"
        sh 'make clean'
        sh 'make logout'
    }
}